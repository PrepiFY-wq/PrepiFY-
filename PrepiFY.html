<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PrepiFY ‚Äì UPSC Daily Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #1f5f8b;
      --primary-light: #2e86c1;
      --background: #f5f7fb;
      --card-bg: #ffffff;
      --accent: #ffb703;
      --danger: #d62828;
      --success: #2b9348;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --border-radius: 12px;
      --shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #e0f2fe, #f5f7fb);
      color: var(--text-main);
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #0f172a, #1f5f8b);
      color: #fff;
      padding: 18px 16px 10px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, #ffb703, #fb8500);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: #0f172a;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-text h1 {
      font-size: 20px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .brand-text span {
      font-size: 11px;
      color: #cbd5f5;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .countdown-box {
      background: rgba(15, 23, 42, 0.65);
      padding: 10px 14px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(8px);
    }

    .countdown-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #cbd5f5;
    }

    .countdown-time {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      gap: 10px;
    }

    .pill {
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 253, 0.4);
      font-size: 12px;
    }

    .quote-box {
      margin-top: 10px;
      background: rgba(15, 23, 42, 0.85);
      border-radius: 14px;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(148, 163, 253, 0.4);
    }

    .quote-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #a5b4fc;
    }

    .quote-text {
      font-size: 13px;
      line-height: 1.4;
    }

    .quote-author {
      font-size: 11px;
      color: #9ca3af;
    }

    main {
      max-width: 1040px;
      margin: 18px auto 32px;
      padding: 0 14px 24px;
    }

    .grid {
      display: grid;
      grid-template-columns: 2.2fr 1.4fr;
      gap: 18px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px 16px 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15, 23, 42, 0.04);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 8px;
    }

    .card-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .card-title h2 {
      font-size: 16px;
    }

    .card-title span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .chip {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-muted);
      background: #f9fafb;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: block;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      background-color: #f9fafb;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background-color 0.15s ease;
    }

    textarea {
      resize: vertical;
      min-height: 68px;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.12);
      background-color: #ffffff;
    }

    .input-inline {
      flex: 1;
      min-width: 120px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.12s ease,
        background-color 0.12s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1f5f8b, #2563eb);
      color: #fff;
      box-shadow: 0 8px 16px rgba(37, 99, 235, 0.35);
    }

    .btn-secondary {
      background: #f9fafb;
      color: var(--text-main);
      border: 1px solid #e5e7eb;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.12);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn-icon {
      font-size: 14px;
    }

    .section {
      margin-top: 10px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .targets-list {
      list-style: none;
      margin-top: 4px;
      max-height: 170px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .targets-list::-webkit-scrollbar {
      width: 4px;
    }

    .targets-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 999px;
    }

    .target-item {
      border-radius: 10px;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .target-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .target-date {
      font-size: 11px;
      color: var(--text-muted);
    }

    .target-meta {
      font-size: 11px;
      color: var(--text-muted);
      align-self: flex-end;
      text-align: right;
      min-width: 88px;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }

    .stat-chip {
      flex: 1;
      min-width: 120px;
      background: #f9fafb;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px dashed #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .stat-value {
      font-weight: 700;
      font-size: 14px;
    }

    .streak-good {
      color: var(--success);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .badge-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: linear-gradient(135deg, #fef9c3, #fffbeb);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-pill.gold {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #0f172a;
      border-color: rgba(234, 179, 8, 0.8);
    }

    .badge-pill.silver {
      background: linear-gradient(135deg, #e5e7eb, #f9fafb);
      color: #111827;
      border-color: rgba(156, 163, 175, 0.8);
    }

    .badge-pill.bronze {
      background: linear-gradient(135deg, #fed7aa, #fdba74);
      color: #7c2d12;
      border-color: rgba(248, 153, 112, 0.8);
    }

    .badge-icon {
      font-size: 13px;
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 13px;
    }

    .leaderboard-table thead {
      background: #f9fafb;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      padding: 7px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    .leaderboard-table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .rank-pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .rank-1 {
      background: #fef9c3;
      color: #854d0e;
    }

    .rank-2 {
      background: #e5e7eb;
      color: #374151;
    }

    .rank-3 {
      background: #fee2e2;
      color: #b91c1c;
    }

    .rank-other {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .rank-update-info {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .footer-note {
      margin-top: 16px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }

    .tagline {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      line-height: 1.5;
    }

    .today-date {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ‡§™‡§• ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ï section */

    .path-pradarshak {
      margin-top: 24px;
    }

    .path-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .path-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #f97316, #ec4899);
      -webkit-background-clip: text;
      color: transparent;
    }

    .path-title-icon {
      font-size: 20px;
    }

    .path-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .story-main-card {
      background: linear-gradient(135deg, #eef2ff, #e0f2fe);
      border-radius: 16px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(79, 70, 229, 0.25);
      box-shadow: 0 10px 24px rgba(79, 70, 229, 0.16);
      position: relative;
      overflow: hidden;
    }

    .story-main-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(239, 68, 68, 0.16), transparent 55%);
      pointer-events: none;
    }

    .story-label-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      margin-bottom: 8px;
    }

    .story-label-pill span {
      font-size: 13px;
    }

    .story-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #111827;
    }

    .story-meta {
      font-size: 11px;
      color: #4b5563;
      margin-bottom: 8px;
    }

    .story-body {
      font-size: 13px;
      line-height: 1.55;
      color: #111827;
      white-space: pre-line;
    }

    .story-divider-title {
      margin-top: 16px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .stories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .story-card {
      position: relative;
      border-radius: 14px;
      padding: 10px 11px;
      background: linear-gradient(135deg, #fef9c3, #ffedd5);
      border: 1px solid rgba(234, 179, 8, 0.6);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
    }

    .story-card:nth-child(3n+2) {
      background: linear-gradient(135deg, #e0f2fe, #f5f3ff);
      border-color: rgba(59, 130, 246, 0.5);
    }

    .story-card:nth-child(3n+3) {
      background: linear-gradient(135deg, #fee2e2, #fffbeb);
      border-color: rgba(248, 113, 113, 0.55);
    }

    .story-card-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .story-card-body {
      font-size: 12px;
      line-height: 1.5;
      color: #111827;
      max-height: 120px;
      overflow-y: auto;
      white-space: pre-line;
    }

    .story-card-meta {
      font-size: 11px;
      color: #4b5563;
      margin-top: 4px;
    }

    .story-empty {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 8px;
    }

  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div class="brand">
        <div class="brand-logo">P</div>
        <div class="brand-text">
          <h1>PrepiFY</h1>
          <span>Daily UPSC CSE progress</span>
        </div>
      </div>

      <div class="countdown-box">
        <div class="countdown-label">UPSC CSE Prelims 2026</div>
        <div class="countdown-time" id="countdown">
          <span class="pill">Loading‚Ä¶</span>
        </div>
      </div>
    </div>

    <div class="quote-box">
      <div class="quote-title">LBSNAA & UPSC spirit</div>
      <div class="quote-text" id="quote-text">
        Building future civil servants, one focused day at a time.
      </div>
      <div class="quote-author" id="quote-author">
        ‚Äì PrepiFY
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- Left: Daily Tracker -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            <h2>Today's Study Tracker</h2>
            <span>Log your targets, topics, and reading time</span>
          </div>
          <span class="chip" id="today-date-chip">Today</span>
        </div>

        <div class="section">
          <div class="section-title">Add your study log</div>
          <div class="form-row">
            <div class="input-inline" style="flex: 2;">
              <label for="targets-input">Today's targets completed</label>
              <textarea id="targets-input" placeholder="E.g. Polity ‚Äì Fundamental Rights, Laxmikanth Ch. 6; Economy ‚Äì Inflation basics"></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="input-inline">
              <label for="topics-input">Topics covered (short)</label>
              <input id="topics-input" type="text" placeholder="E.g. FRs, DPSP, Inflation, WPI, CPI" />
            </div>
            <div class="input-inline">
              <label for="time-input">Total study time (hours)</label>
              <input id="time-input" type="number" min="0" step="0.25" placeholder="E.g. 6.5" />
            </div>
          </div>
          <div class="form-row" style="justify-content: flex-end;">
            <button class="btn-secondary" id="clear-today-btn">
              <span class="btn-icon">‚Ü∫</span> Clear today
            </button>
            <button class="btn-primary" id="save-log-btn">
              <span class="btn-icon">‚úî</span> Save today & update streak
            </button>
          </div>
        </div>

        <div class="section">
          <div class="section-title">Last 7 days logs</div>
          <ul class="targets-list" id="logs-list"></ul>
        </div>

        <div class="section">
          <div class="section-title">Your streak & stats</div>
          <div class="stats-row">
            <div class="stat-chip">
              <span class="stat-label">Current streak</span>
              <span class="stat-value streak-good" id="streak-value">0 days</span>
            </div>
            <div class="stat-chip">
              <span class="stat-label">Best streak</span>
              <span class="stat-value" id="best-streak-value">0 days</span>
            </div>
            <div class="stat-chip">
              <span class="stat-label">Total study time</span>
              <span class="stat-value" id="total-time-value">0 hrs</span>
            </div>
          </div>

          <div class="badge-row" id="badge-row">
            <!-- Badges will be injected here -->
          </div>
        </div>

        <!-- ‡§™‡§• ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ï ‡§∏‡•á‡§ï‡•ç‡§∂‡§® START -->
        <div class="section path-pradarshak">
          <div class="path-header">
            <div>
              <div class="path-title">
                <span class="path-title-icon">üõ£Ô∏è</span>
                <span>‡§™‡§• ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ï</span>
              </div>
              <p class="path-subtitle">
                Admin ke daily life based UPSC motivation stories ‚Äì har din ek nayi kahani, jo tumhe track par rakhe.
              </p>
            </div>
          </div>

          <!-- Latest / Main Story -->
          <div id="path-main-story" class="story-main-card" style="display:none;">
            <div class="story-label-pill">
              <span>‚ú®</span>
              <span>Aaj ki Path Pradarshak Kahani</span>
            </div>
            <div class="story-title" id="path-main-title"></div>
            <div class="story-meta" id="path-main-meta"></div>
            <div class="story-body" id="path-main-body"></div>
          </div>

          <!-- Previous Stories -->
          <div id="path-previous-wrapper" style="margin-top: 6px; display:none;">
            <div class="story-divider-title">Pichhli kahaniyan (archive)</div>
            <div id="path-previous-stories" class="stories-grid"></div>
          </div>

          <p id="path-empty" class="story-empty" style="display:none;">
            Abhi tak koi kahani add nahi hui hai. Jald hi admin yahan se tumhari tayari ka raasta aur clear karega.
          </p>
        </div>
        <!-- ‡§™‡§• ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ï ‡§∏‡•á‡§ï‡•ç‡§∂‡§® END -->

      </section>

      <!-- Right: Leaderboard & Rank -->
      <aside class="card">
        <div class="card-header">
          <div class="card-title">
            <h2>Your Rank & Badges</h2>
            <span>Updated every 2 days based on time + targets</span>
          </div>
          <span class="chip" id="next-rank-update">Rank refresh: calculating‚Ä¶</span>
        </div>

        <p class="tagline">
          PrepiFY simulates a simple leaderboard based on your own discipline ‚Äì
          perfect for solo preparation and accountability.
        </p>

        <div class="section">
          <div class="section-title">Leaderboard snapshot</div>
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Candidate</th>
                <th>Study hrs</th>
                <th>Days logged</th>
              </tr>
            </thead>
            <tbody id="leaderboard-body">
            </tbody>
          </table>
          <p class="rank-update-info" id="rank-note">
            Ranks are recalculated from your own total study hours and days logged.
          </p>
        </div>

        <div class="section">
          <div class="section-title">Rank badges</div>
          <div class="badge-row">
            <span class="badge-pill gold">
              <span class="badge-icon">üèÖ</span> Gold Achiever (Top Rank)
            </span>
            <span class="badge-pill silver">
              <span class="badge-icon">ü•à</span> Silver Scholar
            </span>
            <span class="badge-pill bronze">
              <span class="badge-icon">ü•â</span> Bronze Aspirant
            </span>
            <span class="badge-pill">
              <span class="badge-icon">üìò</span> Consistent Learner
            </span>
          </div>
        </div>

        <p class="footer-note">
          Tip: Fill this log honestly every night, just like your future LBSNAA
          discipline.
        </p>
      </aside>
    </div>
  </main>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzE4hzUuVYxCCvPkCmlZSADihaJgQwb7u0w_aBvC6WP5f8GUC7WNfOIBTbBAClXfL0CgA/exec";

  const PRELIMS_DATE = new Date("2026-05-24T00:00:00+05:30");
  const STORAGE_KEY = "prepify_logs_v1";
  const META_KEY = "prepify_meta_v1";

  /* ‡§™‡§• ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ï stories ke liye keys */
  const PATH_STORAGE_KEY = "prepify_path_pradarshak_stories_v1";

  function formatDateKey(date) {
    return date.toISOString().slice(0, 10);
  }

  function formatDisplayDate(date) {
    return date.toLocaleDateString("en-IN", {
      weekday: "short",
      day: "2-digit",
      month: "short"
    });
  }

  function loadLogs() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : {};
    } catch (e) {
      return {};
    }
  }

  function saveLogs(logs) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
  }

  function loadMeta() {
    try {
      const stored = localStorage.getItem(META_KEY);
      return stored
        ? JSON.parse(stored)
        : { bestStreak: 0, lastRankUpdate: null, pseudoRank: 4 };
    } catch (e) {
      return { bestStreak: 0, lastRankUpdate: null, pseudoRank: 4 };
    }
  }

  function saveMeta(meta) {
    localStorage.setItem(META_KEY, JSON.stringify(meta));
  }

  function updateCountdown() {
    const now = new Date();
    const diff = PRELIMS_DATE - now;

    const container = document.getElementById("countdown");
    if (diff <= 0) {
      container.innerHTML =
        '<span class="pill">Prelims 2026 in progress / completed</span>';
      return;
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((diff / (1000 * 60)) % 60);

    container.innerHTML = `
      <span class="pill">${days} days</span>
      <span class="pill">${hours} hrs</span>
      <span class="pill">${minutes} mins</span>
    `;
  }

  function renderToday() {
    const today = new Date();
    const dateKey = formatDateKey(today);
    const logs = loadLogs();
    const log = logs[dateKey];

    document.getElementById("today-date-chip").textContent =
      "Today ‚Ä¢ " + formatDisplayDate(today);
    document.getElementById("today-date-chip").title =
      "Daily trackers are linked to your device date.";

    document.getElementById("targets-input").value = log ? (log.targets || "") : "";
    document.getElementById("topics-input").value = log ? (log.topics || "") : "";
    document.getElementById("time-input").value = log ? (log.hours || "") : "";
  }

  function calculateStreaks(logs) {
    const keys = Object.keys(logs).sort();
    if (keys.length === 0) {
      return { currentStreak: 0, bestStreak: 0, totalHours: 0, daysLogged: 0 };
    }

    let currentStreak = 0;
    let bestStreak = 0;
    let totalHours = 0;
    let daysLogged = keys.length;

    const today = new Date();
    const todayKey = formatDateKey(today);
    const setKeys = new Set(keys);

    function hasLogFor(date) {
      return setKeys.has(formatDateKey(date));
    }

    let cursor = new Date(todayKey + "T00:00:00");

    if (!hasLogFor(cursor)) {
      const yesterday = new Date(cursor);
      yesterday.setDate(yesterday.getDate() - 1);
      cursor = yesterday;
    }

    while (hasLogFor(cursor)) {
      currentStreak += 1;
      cursor.setDate(cursor.getDate() - 1);
    }

    let lastDate = null;
    let run = 0;
    keys.forEach((key) => {
      const entry = logs[key];
      const h = Number(entry.hours || 0);
      if (!Number.isNaN(h)) totalHours += h;

      const d = new Date(key + "T00:00:00");
      if (!lastDate) {
        run = 1;
      } else {
        const diffDays = (d - lastDate) / (1000 * 60 * 60 * 24);
        run = diffDays === 1 ? run + 1 : 1;
      }
      if (run > bestStreak) bestStreak = run;
      lastDate = d;
    });

    return { currentStreak, bestStreak, totalHours, daysLogged };
  }

  function getRankFromScore(score) {
    if (score >= 200) return 1;
    if (score >= 120) return 2;
    if (score >= 60) return 3;
    return 4;
  }

  function describeRank(rank) {
    switch (rank) {
      case 1:
        return "All India Rank 1 (Simulated)";
      case 2:
        return "All India Rank 2‚Äì10 (Simulated)";
      case 3:
        return "All India Rank 11‚Äì50 (Simulated)";
      default:
        return "All India Rank 51+ (Simulated)";
    }
  }

  // SERVER LEADERBOARD

  function loadLeaderboardFromServer() {
    const url = `${SCRIPT_URL}?action=getLeaderboard`;

    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (!data || !data.success || !Array.isArray(data.rows)) return;
        renderLeaderboardFromRows(data.rows);
      })
      .catch(err => {
        console.error("Leaderboard load error", err);
      });
  }

  function renderLeaderboardFromRows(rows) {
    const tbody = document.getElementById("leaderboard-body");
    tbody.innerHTML = "";

    const ranked = rows.map(r => {
      const totalHours = Number(r.totalHours || 0);
      const daysLogged = Number(r.daysLogged || 0);
      const topicsCount = Number(r.topicsCount || 0);

      const score = totalHours * 5 + daysLogged * 2 + topicsCount * 1;

      return { ...r, totalHours, daysLogged, topicsCount, score };
    })
    .sort((a, b) => b.score - a.score)
    .map((r, idx) => ({ ...r, rank: idx + 1 }));

    const currentUserId = localStorage.getItem("userId");

    ranked.forEach(row => {
      const tr = document.createElement("tr");
      const rankClass =
        row.rank === 1 ? "rank-1" :
        row.rank === 2 ? "rank-2" :
        row.rank === 3 ? "rank-3" : "rank-other";

      const nameLabel = row.userId === currentUserId ? "You" : (row.name || "Aspirant");

      tr.innerHTML = `
        <td>
          <span class="rank-pill ${rankClass}">
            #${row.rank}
          </span>
        </td>
        <td>${nameLabel}</td>
        <td>${row.totalHours.toFixed(1)}</td>
        <td>${row.daysLogged}</td>
      `;
      tbody.appendChild(tr);
    });

    const self = ranked.find(r => r.userId === currentUserId);
    const rankNote = document.getElementById("rank-note");
    if (self) {
      rankNote.textContent =
        `Your current simulated rank: #${self.rank} out of ${ranked.length} aspirants ` +
        `(score from total hours, days logged and topics covered).`;
    } else {
      rankNote.textContent =
        `Leaderboard uses total hours, days logged and topics covered to assign ranks.`;
    }
  }

  // LOCAL BADGES + RANK NOTE (self-only view)
  function renderBadges(stats) {
    const badgeRow = document.getElementById("badge-row");
    badgeRow.innerHTML = "";

    const score = stats.totalHours * 5 + stats.daysLogged * 2;
    const rank = getRankFromScore(score);

    if (rank === 1) {
      badgeRow.innerHTML += `
        <span class="badge-pill gold">
          <span class="badge-icon">üèÖ</span> Gold Achiever
        </span>
      `;
    } else if (rank === 2) {
      badgeRow.innerHTML += `
        <span class="badge-pill silver">
          <span class="badge-icon">ü•à</span> Silver Scholar
        </span>
      `;
    } else if (rank === 3) {
      badgeRow.innerHTML += `
        <span class="badge-pill bronze">
          <span class="badge-icon">ü•â</span> Bronze Aspirant
        </span>
      `;
    } else {
      badgeRow.innerHTML += `
        <span class="badge-pill">
          <span class="badge-icon">üìò</span> Consistent Learner
        </span>
      `;
    }

    if (stats.currentStreak >= 30) {
      badgeRow.innerHTML += `
        <span class="badge-pill">
          <span class="badge-icon">üî•</span> 30-Day Streak
        </span>
      `;
    } else if (stats.currentStreak >= 7) {
      badgeRow.innerHTML += `
        <span class="badge-pill">
          <span class="badge-icon">üî•</span> 7-Day Streak
        </span>
      `;
    }
  }

  function renderStats() {
    const logs = loadLogs();
    const meta = loadMeta();
    const stats = calculateStreaks(logs);

    document.getElementById("streak-value").textContent =
      stats.currentStreak + " days";
    document.getElementById("best-streak-value").textContent =
      (meta.bestStreak || stats.bestStreak) + " days";
    document.getElementById("total-time-value").textContent =
      stats.totalHours.toFixed(1) + " hrs";

    if (stats.bestStreak > (meta.bestStreak || 0)) {
      meta.bestStreak = stats.bestStreak;
      saveMeta(meta);
      document.getElementById("best-streak-value").textContent =
        stats.bestStreak + " days";
    }

    renderBadges(stats);
    renderRankUpdate(meta);
  }

  function renderLogsList() {
    const logs = loadLogs();
    const list = document.getElementById("logs-list");
    list.innerHTML = "";

    const today = new Date();
    const daysToShow = 7;
    for (let i = 0; i < daysToShow; i++) {
      const d = new Date();
      d.setDate(today.getDate() - i);
      const key = formatDateKey(d);
      const log = logs[key];
      if (!log) continue;

      const item = document.createElement("li");
      item.className = "target-item";

      item.innerHTML = `
        <div class="target-main">
          <div><strong>${log.topics || "Targets logged"}</strong></div>
          <div class="target-date">${formatDisplayDate(d)}</div>
          <div>${(log.targets || "").slice(0, 160)}${
            log.targets && log.targets.length > 160 ? "‚Ä¶" : ""
          }</div>
        </div>
        <div class="target-meta">
          <div><strong>${
            (log.hours || 0).toFixed
              ? log.hours.toFixed(1)
              : Number(log.hours || 0).toFixed(1)
          } hrs</strong></div>
          <div>Logged</div>
        </div>
      `;
      list.appendChild(item);
    }

    if (!list.children.length) {
      const empty = document.createElement("li");
      empty.className = "target-item";
      empty.innerHTML =
        '<div class="target-main"><div><strong>No logs yet.</strong></div><div class="target-date">Start with today and build your first streak.</div></div>';
      list.appendChild(empty);
    }
  }

  function saveTodayLog() {
    const today = new Date();
    const key = formatDateKey(today);
    const logs = loadLogs();

    const targets = document.getElementById("targets-input").value.trim();
    const topics = document.getElementById("topics-input").value.trim();
    const timeStr = document.getElementById("time-input").value.trim();
    const hours = timeStr ? Number(timeStr) : 0;

    if (!targets || !topics || !hours) {
      alert("Please fill all fields: targets, topics and time before saving.");
      return;
    }

    const topicsCountToday = topics
      ? topics.split(",").map(t => t.trim()).filter(t => t.length > 0).length
      : 0;

    logs[key] = {
      targets,
      topics,
      hours: Number.isNaN(hours) ? 0 : hours,
      topicsCount: topicsCountToday
    };
    saveLogs(logs);

    renderLogsList();
    renderStats();

    const userId = localStorage.getItem("userId") || "GUEST";
    const name = localStorage.getItem("name") || "Aspirant";

    const url = `${SCRIPT_URL}?action=updateLeaderboard` +
      `&userId=${encodeURIComponent(userId)}` +
      `&name=${encodeURIComponent(name)}` +
      `&hoursToday=${encodeURIComponent(hours)}` +
      `&topicsToday=${encodeURIComponent(topicsCountToday)}` +
      `&hasLogToday=1`;

    fetch(url)
      .then(r => r.json())
      .then(() => {
        loadLeaderboardFromServer();
        alert("Today's log saved. Streaks, rank, badges and leaderboard updated.");
      })
      .catch(() => {
        alert("Today's log saved locally. Leaderboard sync failed, please try again later.");
      });
  }

  function clearToday() {
    const today = new Date();
    const key = formatDateKey(today);
    const logs = loadLogs();
    if (logs[key]) {
      if (
        confirm(
          "This will remove today's log from this device. Are you sure?"
        )
      ) {
        delete logs[key];
        saveLogs(logs);
        renderToday();
        renderLogsList();
        renderStats();
      }
    } else {
      document.getElementById("targets-input").value = "";
      document.getElementById("topics-input").value = "";
      document.getElementById("time-input").value = "";
    }
  }

  function renderRankUpdate(meta) {
    const now = new Date();
    let last = meta.lastRankUpdate ? new Date(meta.lastRankUpdate) : null;

    if (!last) {
      last = now;
      meta.lastRankUpdate = last.toISOString();
      saveMeta(meta);
    }

    const next = new Date(last);
    next.setDate(next.getDate() + 2);

    const diffMs = next - now;
    const chip = document.getElementById("next-rank-update");
    if (diffMs <= 0) {
      meta.lastRankUpdate = now.toISOString();
      saveMeta(meta);
      chip.textContent = "Rank refreshed now";
    } else {
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const diffHours = Math.floor(
        (diffMs / (1000 * 60 * 60)) % 24
      );
      chip.textContent = `Next in ${diffDays}d ${diffHours}h`;
    }
  }

  // Quotes

  const localQuotes = [
    { title: "LBSNAA & UPSC spirit", text: "Somewhere in Mussoorie, a future officer is also reading tonight. Stay at your desk a little longer.", author: "LBSNAA spirit" },
    { title: "Daily discipline", text: "UPSC CSE ek marathon hai, sprint nahi. Har din ki mehnat tumhe LBSNAA ke kareeb le jaati hai.", author: "PrepiFY" },
    { title: "Dholpur House dream", text: "Har roz ek honest study log, kal Dholpur House ki list me tumhara naam bana sakta hai.", author: "PrepiFY" },
    { title: "Focused hour", text: "Aaj ka ek focused hour kal ki ek strong posting aur zyada zimmedari la sakta hai.", author: "PrepiFY" },
    { title: "Chair & chapter", text: "Jitni der tum kursi par tikte ho, utna hi tumhara naam recommendation list ke kareeb chala jaata hai.", author: "PrepiFY" },
    { title: "Room to LBSNAA", text: "Jis kamre me tum aaj akela padh rahe ho, wahi se Mussoorie ki pahadiyon tak ka raasta nikalta hai.", author: "PrepiFY" },
    { title: "Silent effort", text: "Raat ke shant kamre me ki gayi mehnat subah result list me shor machaati hai.", author: "PrepiFY" },
    { title: "Syllabus vs spirit", text: "Syllabus tumhari yaadash ka test hai, lekin UPSC safar tumhari himmat ka test hai.", author: "PrepiFY" },
    { title: "Small pages, big posts", text: "Roz ke kuch pages kal ke bade-bade files aur notes ban jaate hain jo tum officer bankar sign karoge.", author: "PrepiFY" },
    { title: "Retry mindset", text: "Attempt fail ho sakta hai, lekin aspirant tabhi fail hota hai jab woh phir se koshish karna chhod deta hai.", author: "PrepiFY" },
    { title: "Desk as training ground", text: "Aaj ki study table kal ka field posting training ground hai.", author: "PrepiFY" },
    { title: "Comparison trap", text: "UPSC race doosron se nahi, khud ki kal wali version se hoti hai.", author: "PrepiFY" },
    { title: "Slow days", text: "Jis din pace slow ho jaaye, us din bas yahi yaad rakho ‚Äì rukna mana hai.", author: "PrepiFY" },
    { title: "Micro wins", text: "Ek chapter, ek pyq, ek mock ‚Äì ye chhoti jeete hi badi rank banati hain.", author: "PrepiFY" },
    { title: "Dark phase", text: "Sabse zyada doubt wale din hi sabse strong officer banate hain.", author: "PrepiFY" },
    { title: "Revision truth", text: "Thoda kam naya padho, par jo padho use baar‚Äëbaar revise karo ‚Äì DAF me line wahi likhi jaati hai.", author: "PrepiFY" },
    { title: "Noise filter", text: "Log kya kahenge se zyada important hai ki tum apne notes me aaj kya likh rahe ho.", author: "PrepiFY" },
    { title: "Time audit", text: "Mobile ki screen time report se zyada powerful tumhara daily study log hota hai.", author: "PrepiFY" },
    { title: "Late-night edge", text: "Jab duniya reel scroll kar rahi hoti hai, tumhara ek extra hour kal ke interview panel ko impress karta hai.", author: "PrepiFY" },
    { title: "Failure as notes", text: "Har failure ek rough note hai jise clean karke agla attempt topper copy ban sakta hai.", author: "PrepiFY" },
    { title: "Comfort test", text: "Jo din comfortable lagta hai, us din shayad tumne apni limit push nahi ki.", author: "PrepiFY" },
    { title: "3-hour exam, years of prep", text: "Teen ghante ki copy me likhne se pehle saalon tak apne aap ko padhna padta hai.", author: "PrepiFY" },
    { title: "Streak logic", text: "Ek din ka break ek streak tod deta hai, lekin ek din ka comeback pure safar ko bachaa deta hai.", author: "PrepiFY" },
    { title: "Library silence", text: "Library ki khamoshi me likhi gayi line, kal policy document me print hoti hai.", author: "PrepiFY" },
    { title: "Mock fear", text: "Mock se darne wale mains me khud se darte hain; mock ko friend bana lo, dushman nahi.", author: "PrepiFY" },
    { title: "Answer writing lens", text: "Jo cheez tum explanation dekar samjha sakte ho, bas wahi cheez UPSC me marks laati hai.", author: "PrepiFY" },
    { title: "Officer habits now", text: "Officer ki aadatein posting ke baad nahi, preparation ke dauran banti hain.", author: "PrepiFY" },
    { title: "Distraction deal", text: "Har baar jab tum distraction ko reject karte ho, tum apne future cadre ko accept kar rahe hote ho.", author: "PrepiFY" },
    { title: "Why you started", text: "Kabhi thak jao to pages nahi, bas reason yaad karo jiske liye tumne UPSC start kiya tha.", author: "PrepiFY" },
    { title: "Prelims to posting", text: "Ek OMR sheet se safar shuru hota hai, lekin asal mein woh har roz ke honest hours se banta hai.", author: "PrepiFY" }
  ];

  function getTodayKey() {
    return new Date().toISOString().slice(0, 10);
  }

  function fetchDailyQuote() {
    const quoteTextEl = document.getElementById("quote-text");
    const quoteAuthorEl = document.getElementById("quote-author");
    const quoteTitleEl = document.querySelector(".quote-title");

    const todayKey = getTodayKey();
    const storedDate = localStorage.getItem("prepify_quote_date");
    const storedIndex = localStorage.getItem("prepify_quote_index");

    let quote;

    if (storedDate === todayKey && storedIndex !== null) {
      const idx = Number(storedIndex);
      quote = localQuotes[idx] || localQuotes[0];
    } else {
      const idx = Math.floor(Math.random() * localQuotes.length);
      quote = localQuotes[idx];
      localStorage.setItem("prepify_quote_date", todayKey);
      localStorage.setItem("prepify_quote_index", String(idx));
    }

    if (quoteTitleEl && quote.title) {
      quoteTitleEl.textContent = quote.title;
    }
    quoteTextEl.textContent = quote.text;
    quoteAuthorEl.textContent = "‚Äì " + quote.author;
  }

  /* ‡§™‡§• ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ï ‚Äì stories logic */

  /**
   * Story structure:
   * {
   *   id: string,
   *   title: string,
   *   body: string,
   *   date: string (YYYY-MM-DD),
   *   tagLine?: string
   * }
   */

  function loadPathPradarshakStories() {
  // 1. Pehle localStorage check
  try {
    const raw = localStorage.getItem(PATH_STORAGE_KEY);
    if (raw) {
      return JSON.parse(raw);
    }
  } catch (e) {}

  // 2. Agar storage empty hai AND admin ne koi story push nahi ki,
  //    to demo seed use karo
  const demoSeed = [
    {
      id: "demo-" + Date.now(),
      title: "Subah ka ek ghanta jo poore din ko change kar gaya",
      body: "Kal raat admin ne bhi socha ki aaj thoda late uthte hain. Lekin alarm bajte hi ek cheez yaad aayi ‚Äì\n\n\"Jis din tum jaldi uthkar padhte ho, us din duniya tumse ek step peeche reh jaati hai.\"\n\nUsne phone door rakha, bas ek cup chai banayi aur pehle 60 minutes sirf Polity ke notes revise kiye. Baaki din chahe jitna messy ho gaya ho, lekin us ek ghante ne guilt ko door rakha.\n\nTum bhi aaj bas itna socho ‚Äì kya main ek honest subah ka ghanta UPSC ko de sakta hoon?",
      date: formatDateKey(new Date()),
      tagLine: "Admin ki real life se ek chhota sa scene"
    }
  ];

  localStorage.setItem(PATH_STORAGE_KEY, JSON.stringify(demoSeed));
  return demoSeed;
}

  function savePathPradarshakStories(stories) {
    localStorage.setItem(PATH_STORAGE_KEY, JSON.stringify(stories));
  }

  // Ye function admin ke panel se call ho sakta hai (naya story push)
  // Example use:
  // addNewPathStory({ title: "...", body: "...", date: "2026-01-25", tagLine: "..." })
  function addNewPathStory(story) {
    const stories = loadPathPradarshakStories();
    const newStory = {
      id: story.id || ("story-" + Date.now()),
      title: story.title || "Untitled Story",
      body: story.body || "",
      date: story.date || formatDateKey(new Date()),
      tagLine: story.tagLine || ""
    };
    // latest story ko top par rakhne ke liye unshift
    stories.unshift(newStory);
    savePathPradarshakStories(stories);
    renderPathPradarshak();
  }

  function renderPathPradarshak() {
    const stories = loadPathPradarshakStories();

    const mainCard = document.getElementById("path-main-story");
    const mainTitle = document.getElementById("path-main-title");
    const mainMeta = document.getElementById("path-main-meta");
    const mainBody = document.getElementById("path-main-body");

    const prevWrapper = document.getElementById("path-previous-wrapper");
    const prevContainer = document.getElementById("path-previous-stories");
    const emptyEl = document.getElementById("path-empty");

    if (!stories || stories.length === 0) {
      mainCard.style.display = "none";
      prevWrapper.style.display = "none";
      emptyEl.style.display = "block";
      return;
    }

    emptyEl.style.display = "none";

    const [latest, ...rest] = stories;

    // Main story
    mainCard.style.display = "block";
    mainTitle.textContent = latest.title;
    const d = new Date(latest.date + "T00:00:00");
    mainMeta.textContent =
      (latest.tagLine ? latest.tagLine + " ‚Ä¢ " : "") +
      formatDisplayDate(d);
    mainBody.textContent = latest.body;

    // Previous stories
    prevContainer.innerHTML = "";
    if (rest.length > 0) {
      prevWrapper.style.display = "block";
      rest.forEach(st => {
        const card = document.createElement("div");
        card.className = "story-card";

        const dt = new Date(st.date + "T00:00:00");
        card.innerHTML = `
          <div class="story-card-title">${st.title}</div>
          <div class="story-card-body">${st.body}</div>
          <div class="story-card-meta">${st.tagLine ? st.tagLine + " ‚Ä¢ " : ""}${formatDisplayDate(dt)}</div>
        `;
        prevContainer.appendChild(card);
      });
    } else {
      prevWrapper.style.display = "none";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    updateCountdown();
    setInterval(updateCountdown, 60 * 1000);

    const today = new Date();
    document.getElementById("today-date-chip").dataset.date =
      formatDateKey(today);

    renderToday();
    renderLogsList();
    renderStats();
    fetchDailyQuote();

    loadLeaderboardFromServer(); // server se leaderboard

    // ‡§™‡§• ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ï render
    renderPathPradarshak();

    document
      .getElementById("save-log-btn")
      .addEventListener("click", saveTodayLog);
    document
      .getElementById("clear-today-btn")
      .addEventListener("click", clearToday);
  });
</script>

</body>
</html>
